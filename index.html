<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control CxC - Gerald Ram√≠rez (Google Sheets)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --accent-blue: #3b82f6; --accent-green: #10b981; --accent-orange: #f59e0b;
            --accent-red: #ef4444; --accent-purple: #8b5cf6; --accent-cyan: #06b6d4;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 24px 16px; display: flex; flex-direction: column; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { display: flex; align-items: center; gap: 12px; padding: 0 8px 24px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .logo span { font-size: 12px; color: var(--text-secondary); }
        .negocio-selector { background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; }
        .negocio-selector select { background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); }
        .connection-status { padding: 10px 14px; border-radius: 8px; font-size: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .connection-status.connected { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .connection-status.disconnected { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .connection-status.checking { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); border: 1px solid var(--accent-orange); }
        .nav-menu { list-style: none; flex: 1; }
        .nav-item { margin-bottom: 4px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-link.active { background: var(--accent-blue); color: white; }
        .main-content { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-height: 100vh; }
        .header { padding: 20px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-primary); position: sticky; top: 0; z-index: 100; }
        .header h2 { font-size: 24px; font-weight: 600; }
        .header-actions { display: flex; gap: 12px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: #475569; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-info { background: var(--accent-blue); color: white; }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .content { flex: 1; padding: 32px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-secondary); border-radius: 12px; padding: 24px; border: 1px solid var(--border); }
        .stat-card .label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card.success .value { color: var(--accent-green); }
        .stat-card.warning .value { color: var(--accent-orange); }
        .stat-card.danger .value { color: var(--accent-red); }
        .table-container { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .table-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .table-header h3 { font-size: 16px; font-weight: 600; }
        .table-filters { display: flex; gap: 12px; flex-wrap: wrap; }
        .search-input, .filter-select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; color: var(--text-primary); font-size: 14px; }
        .search-input { width: 200px; }
        .filter-select { min-width: 140px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); background: var(--bg-tertiary); }
        td { font-size: 13px; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .badge-purple { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); }
        .alert-critica { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)); border: 1px solid var(--accent-red); border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; animation: pulse-alert 2s infinite; }
        .alert-critica-icon { background: var(--accent-red); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
        .alert-critica-content { flex: 1; }
        .alert-critica-content strong { color: var(--accent-red); font-size: 15px; }
        .alert-critica-content p { margin: 4px 0 0; font-size: 13px; color: var(--text-secondary); }
        @keyframes pulse-alert { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden; transform: scale(0.9); transition: transform 0.3s; display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
        .form-control { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; color: var(--text-primary); font-size: 14px; }
        .form-control:focus { outline: none; border-color: var(--accent-blue); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { grid-template-columns: 1fr 1fr 1fr; }
        .section-panel { display: none; }
        .section-panel.active { display: block; }
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .alert-info { background: rgba(59, 130, 246, 0.15); border: 1px solid var(--accent-blue); color: var(--accent-blue); }
        .alert-warning { background: rgba(245, 158, 11, 0.15); border: 1px solid var(--accent-orange); color: var(--accent-orange); }
        .alert-success { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .alert-danger { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .config-card { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); padding: 24px; margin-bottom: 20px; }
        .config-card h4 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; }
        .toast { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 16px 20px; margin-top: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .info-oc { background: var(--bg-tertiary); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .info-oc h5 { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
        .monto-cobrar { color: var(--accent-green); font-weight: 600; }
        .actions-cell { display: flex; gap: 4px; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .file-upload { border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; }
        .file-upload:hover { border-color: var(--accent-blue); }
        .mapper-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 20px; }
        .mapper-item { display: flex; flex-direction: column; gap: 8px; background: var(--bg-tertiary); padding: 16px; border-radius: 10px; }
        .mapper-item label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .mapper-item select { width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-size: 14px; }
        .preview-section { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); margin-top: 20px; overflow: hidden; }
        .preview-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .preview-table-container { max-height: 400px; overflow: auto; }
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .report-card { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); padding: 24px; cursor: pointer; transition: all 0.2s; }
        .report-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .report-card h4 { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .report-card p { font-size: 13px; color: var(--text-secondary); }
        
        /* ==================== RESPONSIVE MOBILE ==================== */
        /* Bot√≥n men√∫ m√≥vil */
        .mobile-menu-btn { display: none; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); cursor: pointer; }
        .mobile-header { display: none; }
        
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .content { padding: 20px; }
        }
        
        @media (max-width: 768px) {
            /* Sidebar oculto por defecto en m√≥vil */
            .sidebar { 
                position: fixed; 
                left: -280px; 
                top: 0; 
                height: 100vh; 
                z-index: 1001; 
                transition: left 0.3s ease;
                width: 280px;
            }
            .sidebar.open { left: 0; }
            .sidebar-overlay { 
                display: none; 
                position: fixed; 
                top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); 
                z-index: 1000; 
            }
            .sidebar-overlay.open { display: block; }
            
            /* Main content ocupa todo */
            .main-content { margin-left: 0; }
            
            /* Header m√≥vil */
            .mobile-header { 
                display: flex; 
                align-items: center; 
                justify-content: space-between;
                padding: 12px 16px; 
                background: var(--bg-secondary); 
                border-bottom: 1px solid var(--border);
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .mobile-header h1 { font-size: 16px; font-weight: 600; text-align: center; flex: 1; }
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            
            /* Header normal oculto */
            .header { padding: 16px; }
            .header h2 { font-size: 18px; }
            
            /* Contenido */
            .content { padding: 16px; }
            
            /* Stats en 2 columnas */
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
            .stat-card { padding: 16px; }
            .stat-card .value { font-size: 20px; }
            .stat-card .label { font-size: 11px; }
            
            /* Gr√°ficos en una columna */
            .charts-grid { 
                grid-template-columns: 1fr !important; 
            }
            .charts-grid .table-container {
                margin-bottom: 16px;
            }
            
            /* Tablas responsive */
            .table-container { border-radius: 8px; }
            .table-header { padding: 14px 16px; flex-direction: column; align-items: flex-start; }
            .table-header h3 { font-size: 14px; margin-bottom: 12px; }
            .table-filters { width: 100%; }
            .search-input { width: 100%; }
            .filter-select { flex: 1; min-width: 100px; }
            
            table { min-width: 600px; }
            th, td { padding: 10px 8px; font-size: 12px; }
            
            /* Forms */
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            
            /* Modales */
            .modal { width: 95%; max-height: 85vh; border-radius: 12px; }
            .modal-header { padding: 16px; }
            .modal-header h3 { font-size: 16px; }
            .modal-body { padding: 16px; }
            .modal-footer { padding: 16px; flex-wrap: wrap; }
            .modal-footer .btn { flex: 1; justify-content: center; }
            
            /* Botones */
            .btn { padding: 10px 16px; font-size: 13px; }
            .btn-sm { padding: 8px 12px; }
            .actions-cell { gap: 6px; }
            .actions-cell .btn-sm { padding: 8px 10px; }
            
            /* Alertas */
            .alert-critica { flex-direction: column; text-align: center; padding: 16px; }
            .alert-critica-icon { margin-bottom: 8px; }
            .alert-critica .btn { width: 100%; justify-content: center; margin-top: 12px; }
            
            /* Reports grid */
            .reports-grid { grid-template-columns: 1fr; }
            .report-card { padding: 16px; }
            
            /* Dashboard cliente */
            #cliente-dashboard-content .stats-grid { grid-template-columns: repeat(2, 1fr); }
            #cliente-dashboard-content > div[style*="grid-template-columns"] { 
                display: block !important;
            }
            #cliente-dashboard-content > div[style*="grid-template-columns"] > div {
                margin-bottom: 8px;
            }
            
            /* Toasts */
            .toast-container { left: 16px; right: 16px; bottom: 16px; }
            .toast { width: 100%; }
            
            /* Importar Excel */
            .file-upload { padding: 24px 16px; }
            .mapper-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            #cliente-dashboard-content .stats-grid { grid-template-columns: 1fr; }
            .stat-card .value { font-size: 24px; }
            .header h2 { font-size: 16px; }
            .btn { padding: 10px 14px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay hidden" id="loading"><div class="spinner"></div></div>
    
    <!-- Overlay para cerrar sidebar en m√≥vil -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="app-container">
        <!-- Header m√≥vil -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <i data-lucide="menu" style="width:24px;height:24px"></i>
            </button>
            <h1>Control CxC</h1>
            <div id="mobile-conn-status" style="width:12px;height:12px;border-radius:50%;background:var(--accent-orange)"></div>
        </div>
        
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon"><i data-lucide="cloud" style="width:24px;height:24px;color:white"></i></div>
                <div><h1>Control CxC</h1><span id="negocio-nombre">Sin negocio</span></div>
            </div>
            <!-- Selector de Negocio -->
            <div class="negocio-selector">
                <label style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;display:block">NEGOCIO ACTIVO</label>
                <select class="form-control" id="select-negocio" onchange="cambiarNegocio()" style="font-size:13px;padding:8px 12px">
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>
            <div class="connection-status checking" id="conn-status">
                <i data-lucide="wifi" style="width:16px;height:16px"></i>
                <span id="conn-text">Conectando...</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a class="nav-link active" data-section="dashboard" onclick="showSection('dashboard')"><i data-lucide="layout-dashboard"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" data-section="facturas" onclick="showSection('facturas')"><i data-lucide="file-text"></i>Facturas</a></li>
                <li class="nav-item"><a class="nav-link" data-section="importar" onclick="showSection('importar')"><i data-lucide="upload"></i>Importar Excel</a></li>
                <li class="nav-item"><a class="nav-link" data-section="clientes" onclick="showSection('clientes')"><i data-lucide="users"></i>Clientes</a></li>
                <li class="nav-item"><a class="nav-link" data-section="antiguedad" onclick="showSection('antiguedad')"><i data-lucide="clock"></i>Antig√ºedad</a></li>
                <li class="nav-item"><a class="nav-link" data-section="reportes" onclick="showSection('reportes')"><i data-lucide="bar-chart-3"></i>Reportes</a></li>
                <li class="nav-item"><a class="nav-link" data-section="config" onclick="showSection('config')"><i data-lucide="settings"></i>Configuraci√≥n</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- DASHBOARD -->
            <div id="section-dashboard" class="section-panel active">
                <div class="header">
                    <h2>Dashboard</h2>
                    <button class="btn btn-secondary" onclick="refreshData()"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i>Actualizar</button>
                </div>
                <div class="content">
                    <!-- Alerta de facturas cr√≠ticas -->
                    <div id="alerta-critica" class="alert-critica" style="display:none">
                        <div class="alert-critica-icon"><i data-lucide="alert-triangle"></i></div>
                        <div class="alert-critica-content">
                            <strong>‚ö†Ô∏è Atenci√≥n: Facturas con mora cr√≠tica</strong>
                            <p id="alerta-critica-texto"></p>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="verFacturasCriticas()">Ver detalles</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card"><div class="label">Total por Cobrar</div><div class="value" id="stat-total">‚Ç°0</div></div>
                        <div class="stat-card warning"><div class="label">Facturas Pendientes</div><div class="value" id="stat-pendientes">0</div></div>
                        <div class="stat-card danger"><div class="label">Vencidas</div><div class="value" id="stat-vencidas">0</div></div>
                        <div class="stat-card success"><div class="label">Cobrado este Mes</div><div class="value" id="stat-cobrado">‚Ç°0</div></div>
                    </div>
                    
                    <!-- Dashboard por Cliente -->
                    <div class="table-container" style="margin-bottom:24px">
                        <div class="table-header">
                            <h3>üìä Resumen por Cliente</h3>
                            <select class="filter-select" id="dashboard-cliente" onchange="updateClienteDashboard()" style="min-width:250px">
                                <option value="">-- Seleccionar cliente --</option>
                            </select>
                        </div>
                        <div id="cliente-dashboard-content" style="display:none;padding:20px">
                            <div class="stats-grid" style="margin-bottom:16px">
                                <div class="stat-card"><div class="label">Pendiente</div><div class="value" id="cliente-pendiente">‚Ç°0</div></div>
                                <div class="stat-card danger"><div class="label">Vencido</div><div class="value" id="cliente-vencido">‚Ç°0</div></div>
                                <div class="stat-card warning"><div class="label">Fact. Pendientes</div><div class="value" id="cliente-cant-pend">0</div></div>
                                <div class="stat-card"><div class="label">D√≠as Prom. Atraso</div><div class="value" id="cliente-dias-atraso">0</div></div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:14px">
                                <div><strong>√öltima factura:</strong> <span id="cliente-ultima-fac">-</span></div>
                                <div><strong>D√≠as de cr√©dito:</strong> <span id="cliente-dias-credito">-</span></div>
                                <div><strong>C√©dula:</strong> <span id="cliente-cedula">-</span></div>
                                <div><strong>Pend. m√°s antigua:</strong> <span id="cliente-fac-antigua">-</span></div>
                            </div>
                            <div style="margin-top:16px">
                                <button class="btn btn-sm btn-primary" onclick="generarEstadoCuentaRapido()"><i data-lucide="file-text" style="width:14px;height:14px"></i>Estado de Cuenta PDF</button>
                                <button class="btn btn-sm btn-secondary" onclick="verFacturasCliente()"><i data-lucide="eye" style="width:14px;height:14px"></i>Ver Facturas</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gr√°ficos -->
                    <div class="charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
                        <div class="table-container">
                            <div class="table-header"><h3>üìà Tendencia CxC (6 meses)</h3></div>
                            <div style="padding:20px;height:280px">
                                <canvas id="chart-tendencia"></canvas>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-header"><h3>ü•ß Distribuci√≥n por Cliente</h3></div>
                            <div style="padding:20px;height:280px">
                                <canvas id="chart-distribucion"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header"><h3>‚ö†Ô∏è Facturas Vencidas o Pr√≥ximas a Vencer</h3></div>
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Consecutivo</th><th>Cliente</th><th>Monto a Cobrar</th><th>Vencimiento</th><th>Estado</th></tr></thead>
                                <tbody id="tabla-alertas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FACTURAS -->
            <div id="section-facturas" class="section-panel">
                <div class="header">
                    <h2>Facturas</h2>
                    <button class="btn btn-primary" onclick="openModal('modal-factura')"><i data-lucide="plus" style="width:16px;height:16px"></i>Nueva Factura</button>
                </div>
                <div class="content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Todas las Facturas</h3>
                            <div class="table-filters" style="flex-wrap:wrap;gap:8px">
                                <input type="text" class="search-input" placeholder="Buscar..." id="buscar-factura" onkeyup="renderFacturas()">
                                <select class="filter-select" id="filtro-estado" onchange="renderFacturas()">
                                    <option value="">Todos</option>
                                    <option value="pendiente">Pendientes</option>
                                    <option value="pagado">Pagadas/Compensadas</option>
                                    <option value="vencida">Vencidas</option>
                                    <option value="nc">Solo NC</option>
                                </select>
                                <select class="filter-select" id="filtro-cliente" onchange="renderFacturas()">
                                    <option value="">Todos los clientes</option>
                                </select>
                                <input type="date" class="filter-select" id="filtro-fecha-desde" onchange="renderFacturas()" title="Desde">
                                <input type="date" class="filter-select" id="filtro-fecha-hasta" onchange="renderFacturas()" title="Hasta">
                                <button class="btn btn-sm btn-secondary" onclick="limpiarFiltros()" title="Limpiar filtros"><i data-lucide="x" style="width:14px;height:14px"></i></button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Tipo</th><th>Consecutivo</th><th>Fecha</th><th>Cliente</th><th>Total</th><th>CORFOGA</th><th>A Cobrar</th><th>Vencimiento</th><th>Estado</th><th>Acciones</th></tr></thead>
                                <tbody id="tabla-facturas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IMPORTAR -->
            <div id="section-importar" class="section-panel">
                <div class="header"><h2>Importar desde Excel</h2></div>
                <div class="content">
                    <div class="alert alert-info"><i data-lucide="info" style="width:20px;height:20px"></i>Las facturas importadas se guardar√°n directamente en Google Sheets.</div>
                    <div class="config-card">
                        <h4><i data-lucide="upload-cloud" style="width:20px;height:20px"></i> Subir archivo Excel</h4>
                        <div class="file-upload" id="dropzone" onclick="document.getElementById('file-input').click()">
                            <i data-lucide="file-spreadsheet" style="width:48px;height:48px;color:var(--text-muted)"></i>
                            <p style="margin-top:16px">Arrastr√° el archivo o hac√© clic</p>
                            <p id="filename" style="color:var(--accent-blue);margin-top:8px"></p>
                            <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none" onchange="handleFile(this.files[0])">
                        </div>
                    </div>
                    <div id="mapper-section" style="display:none">
                        <div class="config-card">
                            <h4><i data-lucide="columns" style="width:20px;height:20px"></i> Mapeo de Columnas</h4>
                            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px">Seleccion√° qu√© columna del Excel corresponde a cada campo.</p>
                            <div class="mapper-grid" id="mapper-grid"></div>
                            <div style="margin-top:20px"><button class="btn btn-primary" onclick="previewImport()"><i data-lucide="eye" style="width:16px;height:16px"></i>Previsualizar</button></div>
                        </div>
                    </div>
                    <div id="preview-section" style="display:none">
                        <div class="preview-section">
                            <div class="preview-header">
                                <h4>Vista Previa - <span id="preview-count">0</span> facturas</h4>
                                <div><button class="btn btn-success" onclick="doImport()"><i data-lucide="cloud-upload" style="width:16px;height:16px"></i>Importar a Sheets</button></div>
                            </div>
                            <div class="preview-table-container">
                                <table>
                                    <thead><tr><th>Consecutivo</th><th>Fecha</th><th>Cliente</th><th>Total</th></tr></thead>
                                    <tbody id="preview-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="section-clientes" class="section-panel">
                <div class="header">
                    <h2>Clientes</h2>
                    <button class="btn btn-primary" onclick="openModal('modal-cliente')"><i data-lucide="plus" style="width:16px;height:16px"></i>Agregar Cliente</button>
                </div>
                <div class="content">
                    <div class="alert alert-success"><i data-lucide="cloud" style="width:20px;height:20px"></i>Los clientes se guardan en Google Sheets autom√°ticamente.</div>
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Cliente</th><th>Identificaci√≥n</th><th>D√≠as Cr√©dito</th><th>Estado</th><th>Facturas</th><th>Acciones</th></tr></thead>
                                <tbody id="tabla-clientes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANTIG√úEDAD DE CARTERA -->
            <div id="section-antiguedad" class="section-panel">
                <div class="header">
                    <h2>Antig√ºedad de Cartera</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadAntiguedad()"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i>Actualizar</button>
                        <button class="btn btn-primary" onclick="exportAntiguedadExcel()"><i data-lucide="table" style="width:16px;height:16px"></i>Excel</button>
                        <button class="btn btn-danger" onclick="exportAntiguedadPDF()"><i data-lucide="file-text" style="width:16px;height:16px"></i>PDF</button>
                    </div>
                </div>
                <div class="content">
                    <!-- Resumen de Antig√ºedad -->
                    <div class="stats-grid" style="margin-bottom:24px">
                        <div class="stat-card" style="border-left:4px solid var(--accent-green)">
                            <div class="label">0-30 d√≠as (Corriente)</div>
                            <div class="value" id="ant-corriente">‚Ç°0</div>
                            <small class="text-secondary" id="ant-corriente-pct">0%</small>
                        </div>
                        <div class="stat-card" style="border-left:4px solid var(--accent-orange)">
                            <div class="label">31-60 d√≠as</div>
                            <div class="value" id="ant-31-60">‚Ç°0</div>
                            <small class="text-secondary" id="ant-31-60-pct">0%</small>
                        </div>
                        <div class="stat-card" style="border-left:4px solid #f97316">
                            <div class="label">61-90 d√≠as</div>
                            <div class="value" id="ant-61-90">‚Ç°0</div>
                            <small class="text-secondary" id="ant-61-90-pct">0%</small>
                        </div>
                        <div class="stat-card" style="border-left:4px solid var(--accent-red)">
                            <div class="label">+90 d√≠as (Cr√≠tico)</div>
                            <div class="value" id="ant-90-mas">‚Ç°0</div>
                            <small class="text-secondary" id="ant-90-mas-pct">0%</small>
                        </div>
                    </div>

                    <!-- Gr√°fico de Barras -->
                    <div class="table-container" style="margin-bottom:24px;padding:24px">
                        <h3 style="margin-bottom:16px">üìä Distribuci√≥n de Cartera</h3>
                        <div style="height:250px;position:relative">
                            <canvas id="chart-antiguedad"></canvas>
                        </div>
                    </div>

                    <!-- Tabla de Facturas por Antig√ºedad -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3>üìã Detalle por Categor√≠a</h3>
                            <select class="filter-select" id="filtro-antiguedad" onchange="renderAntiguedad()">
                                <option value="todas">Todas las categor√≠as</option>
                                <option value="corriente">0-30 d√≠as</option>
                                <option value="dias_31_60">31-60 d√≠as</option>
                                <option value="dias_61_90">61-90 d√≠as</option>
                                <option value="dias_90_mas">+90 d√≠as</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Consecutivo</th>
                                        <th>Cliente</th>
                                        <th>Vencimiento</th>
                                        <th>Monto</th>
                                        <th>Abonado</th>
                                        <th>Saldo</th>
                                        <th>D√≠as</th>
                                        <th>Categor√≠a</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-antiguedad"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="section-reportes" class="section-panel">
                <div class="header"><h2>Reportes</h2></div>
                <div class="content">
                    <div class="alert alert-info"><i data-lucide="info" style="width:20px;height:20px"></i>Eleg√≠ el formato: Excel para editar datos, PDF para presentaciones.</div>
                    <div class="reports-grid">
                        <div class="report-card">
                            <h4><i data-lucide="users" style="width:24px;height:24px;color:var(--accent-cyan)"></i>Resumen por Cliente</h4>
                            <p>Saldo pendiente y vencido de todos los clientes.</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="downloadReport('resumen-clientes')"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                                <button class="btn btn-sm btn-danger" onclick="downloadReport('resumen-clientes/pdf')"><i data-lucide="file-text" style="width:14px;height:14px"></i>PDF</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <h4><i data-lucide="calendar" style="width:24px;height:24px;color:var(--accent-blue)"></i>Reporte Semanal</h4>
                            <p>Facturas pendientes, vencidas y pr√≥ximas a vencer.</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="downloadReport('semanal')"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                                <button class="btn btn-sm btn-danger" onclick="downloadReport('semanal/pdf')"><i data-lucide="file-text" style="width:14px;height:14px"></i>PDF</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <h4><i data-lucide="user" style="width:24px;height:24px;color:var(--accent-green)"></i>Estado de Cuenta</h4>
                            <p>Estado de cuenta por cliente.</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="openModal('modal-reporte-cliente')"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                                <button class="btn btn-sm btn-danger" onclick="openModal('modal-reporte-cliente-pdf')"><i data-lucide="file-text" style="width:14px;height:14px"></i>PDF</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <h4><i data-lucide="clock" style="width:24px;height:24px;color:var(--accent-orange)"></i>Antig√ºedad de Cartera</h4>
                            <p>Clasificaci√≥n por d√≠as de vencimiento.</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="exportAntiguedadExcel()"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                                <button class="btn btn-sm btn-danger" onclick="exportAntiguedadPDF()"><i data-lucide="file-text" style="width:14px;height:14px"></i>PDF</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <h4><i data-lucide="alert-triangle" style="width:24px;height:24px;color:var(--accent-red)"></i>Facturas Vencidas</h4>
                            <p>Lista ordenada por d√≠as de atraso.</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="downloadReport('vencidas')"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                                <button class="btn btn-sm btn-danger" onclick="downloadReport('vencidas/pdf')"><i data-lucide="file-text" style="width:14px;height:14px"></i>PDF</button>
                            </div>
                        </div>
                        <div class="report-card">
                            <h4><i data-lucide="download" style="width:24px;height:24px;color:var(--accent-purple)"></i>Exportar Todo</h4>
                            <p>Backup completo de datos (solo Excel).</p>
                            <div style="display:flex;gap:8px;margin-top:12px">
                                <button class="btn btn-sm btn-secondary" onclick="downloadReport('exportar-todo')"><i data-lucide="table" style="width:14px;height:14px"></i>Excel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONFIGURACI√ìN -->
            <div id="section-config" class="section-panel">
                <div class="header"><h2>Configuraci√≥n</h2></div>
                <div class="content">
                    <!-- Gesti√≥n de Negocios -->
                    <div class="table-container" style="max-width:800px;margin-bottom:24px">
                        <div class="table-header">
                            <h3>üè™ Negocios / Clientes Contables</h3>
                            <button class="btn btn-sm btn-primary" onclick="openModal('modal-negocio')"><i data-lucide="plus" style="width:14px;height:14px"></i>Agregar Negocio</button>
                        </div>
                        <div style="padding:20px">
                            <p style="color:var(--text-secondary);margin-bottom:16px">Cada negocio tiene su propio Google Sheet con datos independientes.</p>
                            <div class="table-wrapper">
                                <table>
                                    <thead><tr><th>Nombre</th><th>Descripci√≥n</th><th>Sheet ID</th><th>Estado</th><th>Acciones</th></tr></thead>
                                    <tbody id="tabla-negocios"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-width:700px">
                        <div class="table-header"><h3>üè¢ Datos de la Empresa (Negocio Actual)</h3></div>
                        <div style="padding:24px">
                            <p style="color:var(--text-secondary);margin-bottom:20px">Estos datos aparecer√°n en los reportes PDF y estados de cuenta del negocio activo.</p>
                            <div class="form-group">
                                <label>Nombre de la Empresa / Propietario</label>
                                <input type="text" class="form-control" id="config-nombre" placeholder="Ej: Gerald Ram√≠rez">
                            </div>
                            <div class="form-group">
                                <label>C√©dula / RUC</label>
                                <input type="text" class="form-control" id="config-cedula" placeholder="Ej: 1-2345-6789">
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n del Negocio</label>
                                <input type="text" class="form-control" id="config-descripcion" placeholder="Ej: Ganader√≠a y Comercializaci√≥n de Ganado">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tel√©fono</label>
                                    <input type="text" class="form-control" id="config-telefono" placeholder="Ej: +506 8888-8888">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="config-email" placeholder="Ej: contacto@empresa.com">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Direcci√≥n</label>
                                <input type="text" class="form-control" id="config-direccion" placeholder="Ej: San Carlos, Alajuela, Costa Rica">
                            </div>
                            <hr style="border-color:var(--border);margin:24px 0">
                            <div class="form-group">
                                <label>Mensaje en Estados de Cuenta</label>
                                <input type="text" class="form-control" id="config-mensaje" placeholder="Ej: Gracias por su preferencia">
                            </div>
                            <div style="display:flex;gap:12px;margin-top:24px">
                                <button class="btn btn-primary" onclick="saveConfig()"><i data-lucide="save" style="width:16px;height:16px"></i>Guardar Configuraci√≥n</button>
                                <button class="btn btn-secondary" onclick="loadConfig()"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i>Recargar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acceso Dashboard Solo Lectura -->
                    <div class="table-container" style="max-width:700px;margin-top:24px">
                        <div class="table-header"><h3>üëÅÔ∏è Acceso Dashboard (Solo Lectura)</h3></div>
                        <div style="padding:24px">
                            <p style="color:var(--text-secondary);margin-bottom:20px">Gener√° un link para que tu cliente (el due√±o del negocio) pueda ver sus CxC sin poder editar nada.</p>
                            <div class="form-group">
                                <label>C√≥digo de Acceso (m√≠nimo 4 caracteres)</label>
                                <input type="text" class="form-control" id="dashboard-codigo" placeholder="Ej: gerald2024" style="max-width:300px">
                                <small style="color:var(--text-secondary)">Este c√≥digo lo usar√° tu cliente para ingresar al dashboard.</small>
                            </div>
                            <button class="btn btn-primary" onclick="generarAccesoDashboard()">
                                <i data-lucide="link" style="width:16px;height:16px"></i>Generar Link de Acceso
                            </button>
                            <div id="dashboard-link-resultado" style="margin-top:16px;display:none">
                                <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px">
                                    <p style="margin-bottom:8px;color:var(--accent-green)">‚úì Link generado:</p>
                                    <code id="dashboard-link-url" style="word-break:break-all;font-size:12px"></code>
                                    <div style="display:flex;gap:8px;margin-top:12px">
                                        <button class="btn btn-sm btn-secondary" onclick="copiarLinkDashboard()"><i data-lucide="copy" style="width:14px;height:14px"></i>Copiar</button>
                                        <button class="btn btn-sm btn-success" onclick="enviarLinkDashboardWhatsApp()"><i data-lucide="message-circle" style="width:14px;height:14px"></i>WhatsApp</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL NEGOCIO -->
    <div class="modal-overlay" id="modal-negocio">
        <div class="modal" style="max-width:550px">
            <div class="modal-header"><h3 id="modal-negocio-titulo">Agregar Negocio</h3><button class="modal-close" onclick="closeModal('modal-negocio')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="negocio-id">
                <div class="form-group">
                    <label>Nombre del Negocio *</label>
                    <input type="text" class="form-control" id="negocio-nombre-input" placeholder="Ej: Gerald Ram√≠rez - Ganader√≠a">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <input type="text" class="form-control" id="negocio-descripcion" placeholder="Ej: Control de cuentas por cobrar">
                </div>
                <div class="form-group">
                    <label>Google Sheet ID *</label>
                    <input type="text" class="form-control" id="negocio-sheet-id" placeholder="Ej: 1bcCNoENKotBz3p1FUkVBMirBWSYVHP-JAWjjJHbx5Js">
                    <small style="color:var(--text-secondary)">El ID est√° en la URL del Sheet: docs.google.com/spreadsheets/d/<b>[ESTE_ES_EL_ID]</b>/edit</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-negocio')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveNegocio()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal-overlay" id="modal-cliente">
        <div class="modal">
            <div class="modal-header"><h3 id="modal-cliente-titulo">Agregar Cliente</h3><button class="modal-close" onclick="closeModal('modal-cliente')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="cliente-id">
                <div class="form-group"><label>Nombre *</label><input type="text" class="form-control" id="cliente-nombre"></div>
                <div class="form-group"><label>Identificaci√≥n *</label><input type="text" class="form-control" id="cliente-identificacion"></div>
                <div class="form-group"><label>D√≠as de Cr√©dito</label><input type="number" class="form-control" id="cliente-dias" value="8"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-cliente')">Cancelar</button><button class="btn btn-primary" onclick="saveCliente()">Guardar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-factura">
        <div class="modal">
            <div class="modal-header"><h3>Nueva Factura</h3><button class="modal-close" onclick="closeModal('modal-factura')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Consecutivo *</label><input type="text" class="form-control" id="factura-consecutivo"></div>
                    <div class="form-group"><label>Fecha *</label><input type="date" class="form-control" id="factura-fecha"></div>
                </div>
                <div class="form-group"><label>Cliente *</label><select class="form-control" id="factura-cliente"></select></div>
                <div class="form-group"><label>Total Factura *</label><input type="number" class="form-control" id="factura-total" step="0.01" oninput="calcMonto()"></div>
                <div class="info-oc">
                    <h5>üìã Datos de la Orden de Compra</h5>
                    <div class="form-row form-row-3">
                        <div class="form-group"><label>CORFOGA</label><input type="number" class="form-control" id="factura-corfoga" step="0.01" value="0" oninput="calcMonto()"></div>
                        <div class="form-group"><label>Otros Rebajos</label><input type="number" class="form-control" id="factura-otros" step="0.01" value="0" oninput="calcMonto()"></div>
                        <div class="form-group"><label>Monto a Cobrar</label><input type="text" class="form-control monto-cobrar" id="factura-monto" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tipo Producto</label><select class="form-control" id="factura-tipo"><option value="">-</option><option>Ganado en pie</option><option>Ganado en canal</option><option>Alimentaci√≥n</option><option>Servicio de engorde</option></select></div>
                        <div class="form-group"><label>N¬∞ OC</label><input type="text" class="form-control" id="factura-oc"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-factura')">Cancelar</button><button class="btn btn-primary" onclick="saveFactura()">Guardar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-editar">
        <div class="modal">
            <div class="modal-header"><h3>Editar Factura</h3><button class="modal-close" onclick="closeModal('modal-editar')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="editar-id">
                <div class="form-row">
                    <div class="form-group"><label>Consecutivo</label><input type="text" class="form-control" id="editar-consecutivo" readonly></div>
                    <div class="form-group"><label>Cliente</label><input type="text" class="form-control" id="editar-cliente" readonly></div>
                </div>
                <div class="form-group"><label>Total Factura</label><input type="number" class="form-control" id="editar-total" step="0.01" oninput="calcMontoEdit()"></div>
                <div class="info-oc">
                    <h5>üìã Datos de la Orden de Compra</h5>
                    <div class="form-row form-row-3">
                        <div class="form-group"><label>CORFOGA</label><input type="number" class="form-control" id="editar-corfoga" step="0.01" oninput="calcMontoEdit()"></div>
                        <div class="form-group"><label>Otros Rebajos</label><input type="number" class="form-control" id="editar-otros" step="0.01" oninput="calcMontoEdit()"></div>
                        <div class="form-group"><label>Monto a Cobrar</label><input type="text" class="form-control monto-cobrar" id="editar-monto" readonly></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tipo Producto</label><select class="form-control" id="editar-tipo"><option value="">-</option><option>Ganado en pie</option><option>Ganado en canal</option><option>Alimentaci√≥n</option><option>Servicio de engorde</option></select></div>
                        <div class="form-group"><label>N¬∞ OC</label><input type="text" class="form-control" id="editar-oc"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-editar')">Cancelar</button><button class="btn btn-primary" onclick="updateFactura()">Guardar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-pago">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3>Registrar Pago</h3><button class="modal-close" onclick="closeModal('modal-pago')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="pago-id">
                <input type="hidden" id="pago-monto-original">
                <div class="form-group"><label>Factura</label><input type="text" class="form-control" id="pago-factura" readonly></div>
                <div class="form-group"><label>Monto Pendiente</label><input type="text" class="form-control monto-cobrar" id="pago-monto" readonly></div>
                <div class="form-group">
                    <label>Tipo de Pago</label>
                    <div style="display:flex;gap:16px;margin-top:8px">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="radio" name="tipo-pago" value="total" checked onchange="togglePagoParcial()"> Pago Total
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="radio" name="tipo-pago" value="parcial" onchange="togglePagoParcial()"> Pago Parcial
                        </label>
                    </div>
                </div>
                <div class="form-group" id="pago-parcial-grupo" style="display:none">
                    <label>Monto a Abonar</label>
                    <input type="number" class="form-control" id="pago-monto-parcial" step="0.01" placeholder="0.00">
                    <small style="color:var(--text-secondary)">El saldo restante quedar√° pendiente</small>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fecha de Pago</label><input type="date" class="form-control" id="pago-fecha"></div>
                    <div class="form-group">
                        <label>M√©todo de Pago</label>
                        <select class="form-control" id="pago-metodo">
                            <option value="Transferencia">Transferencia</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Cheque">Cheque</option>
                            <option value="SINPE">SINPE M√≥vil</option>
                            <option value="Dep√≥sito">Dep√≥sito</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Referencia / Notas</label><input type="text" class="form-control" id="pago-referencia" placeholder="Ej: #Transferencia, #Cheque, etc."></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-pago')">Cancelar</button><button class="btn btn-success" onclick="doPago()">Confirmar Pago</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-reporte-cliente">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3>Estado de Cuenta (Excel)</h3><button class="modal-close" onclick="closeModal('modal-reporte-cliente')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Seleccionar Cliente</label><select class="form-control" id="reporte-cliente"></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-reporte-cliente')">Cancelar</button><button class="btn btn-primary" onclick="downloadReportCliente()">Generar Excel</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-reporte-cliente-pdf">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3>Estado de Cuenta (PDF)</h3><button class="modal-close" onclick="closeModal('modal-reporte-cliente-pdf')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Seleccionar Cliente</label><select class="form-control" id="reporte-cliente-pdf"></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-reporte-cliente-pdf')">Cancelar</button><button class="btn btn-danger" onclick="downloadReportClientePDF()">Generar PDF</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-compensar">
        <div class="modal" style="max-width:600px">
            <div class="modal-header"><h3>Compensar Nota de Cr√©dito</h3><button class="modal-close" onclick="closeModal('modal-compensar')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="compensar-nc-id">
                <div class="alert alert-info" style="margin-bottom:20px">
                    <i data-lucide="info" style="width:20px;height:20px"></i>
                    <div>
                        <strong>NC: <span id="compensar-nc-consecutivo"></span></strong><br>
                        <span>Monto: <span id="compensar-nc-monto" class="monto-cobrar"></span></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Seleccionar Factura a Anular</label>
                    <select class="form-control" id="compensar-factura" onchange="updateMontoCompensar()">
                        <option value="">-- Seleccionar factura --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto a Compensar</label>
                    <input type="number" class="form-control" id="compensar-monto" step="0.01">
                    <small style="color:var(--text-secondary)">Por defecto se compensa el 100% del monto menor entre NC y Factura</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-compensar')">Cancelar</button>
                <button class="btn btn-primary" onclick="doCompensar()">Compensar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-info-pago">
        <div class="modal" style="max-width:450px">
            <div class="modal-header"><h3>Informaci√≥n de Pago</h3><button class="modal-close" onclick="closeModal('modal-info-pago')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div style="background:var(--bg-tertiary);border-radius:12px;padding:20px">
                    <div style="display:grid;gap:12px">
                        <div><strong style="color:var(--text-secondary)">Factura:</strong><br><span id="info-pago-factura"></span></div>
                        <div><strong style="color:var(--text-secondary)">Cliente:</strong><br><span id="info-pago-cliente"></span></div>
                        <div><strong style="color:var(--text-secondary)">Monto Cobrado:</strong><br><span id="info-pago-monto" class="monto-cobrar" style="font-size:18px"></span></div>
                        <hr style="border-color:var(--border)">
                        <div><strong style="color:var(--text-secondary)">Fecha de Pago:</strong><br><span id="info-pago-fecha"></span></div>
                        <div><strong style="color:var(--text-secondary)">Detalle:</strong><br><span id="info-pago-detalle"></span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-info-pago')">Cerrar</button></div>
        </div>
    </div>

    <!-- Modal Historial de Abonos -->
    <div class="modal-overlay" id="modal-abonos">
        <div class="modal" style="max-width:700px">
            <div class="modal-header">
                <h3>üí∞ Historial de Abonos</h3>
                <button class="modal-close" onclick="closeModal('modal-abonos')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="abonos-factura-id">
                <div style="background:var(--bg-tertiary);border-radius:12px;padding:16px;margin-bottom:20px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div><strong style="color:var(--text-secondary)">Factura:</strong><br><span id="abonos-consecutivo" style="font-size:16px"></span></div>
                        <div><strong style="color:var(--text-secondary)">Cliente:</strong><br><span id="abonos-cliente"></span></div>
                        <div><strong style="color:var(--text-secondary)">Monto a Cobrar:</strong><br><span id="abonos-monto-cobrar" class="monto-cobrar"></span></div>
                        <div><strong style="color:var(--text-secondary)">Total Abonado:</strong><br><span id="abonos-total" style="color:var(--accent-green)"></span></div>
                    </div>
                    <hr style="border-color:var(--border);margin:12px 0">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Saldo Pendiente:</strong></div>
                        <div id="abonos-saldo" style="font-size:20px;font-weight:700;color:var(--accent-orange)"></div>
                    </div>
                </div>
                
                <!-- Formulario para nuevo abono -->
                <div style="background:var(--bg-secondary);border:1px dashed var(--border);border-radius:12px;padding:16px;margin-bottom:20px">
                    <h4 style="margin-bottom:12px;color:var(--accent-blue)">‚ûï Registrar Nuevo Abono</h4>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom:0">
                            <label>Monto</label>
                            <input type="number" class="form-control" id="nuevo-abono-monto" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>Fecha</label>
                            <input type="date" class="form-control" id="nuevo-abono-fecha">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top:12px">
                        <div class="form-group" style="margin-bottom:0">
                            <label>M√©todo</label>
                            <select class="form-control" id="nuevo-abono-metodo">
                                <option value="Transferencia">Transferencia</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Cheque">Cheque</option>
                                <option value="SINPE">SINPE M√≥vil</option>
                                <option value="Dep√≥sito">Dep√≥sito</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:0">
                            <label>Referencia</label>
                            <input type="text" class="form-control" id="nuevo-abono-referencia" placeholder="Ej: #12345">
                        </div>
                    </div>
                    <button class="btn btn-success" style="margin-top:12px;width:100%" onclick="registrarAbono()">
                        <i data-lucide="plus" style="width:16px;height:16px"></i> Registrar Abono
                    </button>
                </div>
                
                <!-- Lista de Abonos -->
                <h4 style="margin-bottom:12px">üìã Abonos Registrados</h4>
                <div id="lista-abonos" style="max-height:250px;overflow-y:auto">
                    <p style="color:var(--text-secondary);text-align:center;padding:20px">Cargando abonos...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modal-abonos')">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // ===================== CONFIG =====================
        const API = 'https://web-production-66499.up.railway.app/api';
        let state = { clientes: [], facturas: [], negocios: [], connected: false, excelData: [], excelCols: [], antiguedad: null };
        let chartAntiguedad = null;

        // ===================== MOBILE SIDEBAR =====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        
        function closeSidebarOnMobile() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        // ===================== API CALLS =====================
        async function api(endpoint, method = 'GET', data = null) {
            try {
                const opts = { method, headers: { 'Content-Type': 'application/json' } };
                if (data) opts.body = JSON.stringify(data);
                const res = await fetch(API + endpoint, opts);
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return { success: false, error: 'Sin conexi√≥n al servidor' };
            }
        }

        async function checkConnection() {
            const el = document.getElementById('conn-status');
            const txt = document.getElementById('conn-text');
            const mobileStatus = document.getElementById('mobile-conn-status');
            el.className = 'connection-status checking';
            txt.textContent = 'Conectando...';
            if (mobileStatus) mobileStatus.style.background = 'var(--accent-orange)';
            
            const res = await api('/health');
            if (res.success) {
                el.className = 'connection-status connected';
                txt.textContent = 'Google Sheets ‚úì';
                state.connected = true;
                if (mobileStatus) mobileStatus.style.background = 'var(--accent-green)';
            } else {
                el.className = 'connection-status disconnected';
                txt.textContent = 'Sin conexi√≥n';
                state.connected = false;
                if (mobileStatus) mobileStatus.style.background = 'var(--accent-red)';
                toast('Backend no disponible', 'error');
            }
            lucide.createIcons();
        }

        // ===================== UI HELPERS =====================
        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        
        function toast(msg, type = 'success') {
            const c = document.getElementById('toasts');
            const t = document.createElement('div');
            t.className = 'toast';
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'alert-circle';
            const color = type === 'success' ? 'var(--accent-green)' : type === 'error' ? 'var(--accent-red)' : 'var(--accent-orange)';
            t.innerHTML = `<i data-lucide="${icon}" style="width:20px;height:20px;color:${color}"></i><span>${msg}</span>`;
            c.appendChild(t);
            lucide.createIcons();
            setTimeout(() => t.remove(), 4000);
        }

        function showSection(s) {
            document.querySelectorAll('.section-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('section-' + s).classList.add('active');
            document.querySelector(`[data-section="${s}"]`).classList.add('active');
            closeSidebarOnMobile();
            
            // Cargar datos de antig√ºedad si es esa secci√≥n
            if (s === 'antiguedad' && !state.antiguedad) {
                loadAntiguedad();
            }
        }

        function openModal(id) { 
            document.getElementById(id).classList.add('active'); 
            if (id === 'modal-factura') {
                document.getElementById('factura-fecha').value = new Date().toISOString().split('T')[0];
                fillClienteSelect('factura-cliente');
                calcMonto();
            }
            if (id === 'modal-reporte-cliente') fillClienteSelect('reporte-cliente');
            if (id === 'modal-reporte-cliente-pdf') fillClienteSelect('reporte-cliente-pdf');
            lucide.createIcons();
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function fmt(n) { return (n || 0).toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function fmtDate(d) { 
            if (!d) return '-'; 
            const parts = d.split('T')[0].split('-');
            if (parts.length !== 3) return d;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        function getMonto(f) { return (f.totalFactura || 0) - (f.corfoga || 0) - (f.otrosRebajos || 0); }

        function calcMonto() {
            const t = parseFloat(document.getElementById('factura-total').value) || 0;
            const c = parseFloat(document.getElementById('factura-corfoga').value) || 0;
            const o = parseFloat(document.getElementById('factura-otros').value) || 0;
            document.getElementById('factura-monto').value = '‚Ç°' + fmt(t - c - o);
        }

        function calcMontoEdit() {
            const t = parseFloat(document.getElementById('editar-total').value) || 0;
            const c = parseFloat(document.getElementById('editar-corfoga').value) || 0;
            const o = parseFloat(document.getElementById('editar-otros').value) || 0;
            document.getElementById('editar-monto').value = '‚Ç°' + fmt(t - c - o);
        }

        function fillClienteSelect(id, keepValue = false) {
            const sel = document.getElementById(id);
            const currentValue = keepValue ? sel.value : '';
            sel.innerHTML = '<option value="">Seleccionar...</option>' + 
                state.clientes.filter(c => c.activo !== false).map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            if (keepValue && currentValue) sel.value = currentValue;
        }

        // ===================== LOAD DATA =====================
        async function loadClientes() {
            const res = await api('/clientes');
            if (res.success) state.clientes = res.data || [];
        }

        async function loadFacturas() {
            const res = await api('/facturas');
            if (res.success) state.facturas = res.data || [];
        }

        async function refreshData() {
            if (!state.connected) { toast('Sin conexi√≥n', 'error'); return; }
            showLoading();
            await loadClientes();
            await loadFacturas();
            updateDashboard();
            renderClientes();
            renderFacturas();
            hideLoading();
            toast('Datos actualizados');
        }

        // ===================== CLIENTES =====================
        function renderClientes() {
            const tbody = document.getElementById('tabla-clientes');
            if (!state.clientes.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay clientes</td></tr>';
                return;
            }
            tbody.innerHTML = state.clientes.map(c => {
                const cant = state.facturas.filter(f => f.clienteId === c.id).length;
                const activo = c.activo !== false;
                return `<tr>
                    <td><strong>${c.nombre}</strong></td>
                    <td><code>${c.identificacion}</code></td>
                    <td>${c.diasVencimiento || 8} d√≠as</td>
                    <td><span class="badge ${activo ? 'badge-success' : 'badge-warning'}">${activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${cant}</td>
                    <td class="actions-cell">
                        <button class="btn btn-info btn-sm" onclick="generarLinkPortal('${c.id}', '${c.nombre}')" title="Link de consulta"><i data-lucide="link" style="width:14px;height:14px"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="editCliente('${c.id}')"><i data-lucide="edit-2" style="width:14px;height:14px"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleCliente('${c.id}')"><i data-lucide="${activo ? 'eye-off' : 'eye'}" style="width:14px;height:14px"></i></button>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        async function saveCliente() {
            const id = document.getElementById('cliente-id').value;
            const nombre = document.getElementById('cliente-nombre').value.trim();
            const identificacion = document.getElementById('cliente-identificacion').value.trim();
            const dias = parseInt(document.getElementById('cliente-dias').value) || 8;

            if (!nombre || !identificacion) { toast('Complet√° los campos', 'error'); return; }

            showLoading();
            let res;
            if (id) {
                res = await api(`/clientes/${id}`, 'PUT', { nombre, identificacion, diasVencimiento: dias });
            } else {
                res = await api('/clientes', 'POST', { nombre, identificacion, diasVencimiento: dias });
            }
            
            if (res.success) {
                await loadClientes();
                renderClientes();
                closeModal('modal-cliente');
                toast(id ? 'Cliente actualizado' : 'Cliente guardado en Sheets');
                clearClienteForm();
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        function editCliente(id) {
            const c = state.clientes.find(x => x.id === id);
            if (!c) return;
            document.getElementById('modal-cliente-titulo').textContent = 'Editar Cliente';
            document.getElementById('cliente-id').value = c.id;
            document.getElementById('cliente-nombre').value = c.nombre;
            document.getElementById('cliente-identificacion').value = c.identificacion;
            document.getElementById('cliente-dias').value = c.diasVencimiento || 8;
            openModal('modal-cliente');
        }

        async function toggleCliente(id) {
            showLoading();
            await api(`/clientes/${id}/toggle`, 'POST');
            await loadClientes();
            renderClientes();
            hideLoading();
            toast('Estado actualizado');
        }

        async function generarLinkPortal(clienteId, clienteNombre) {
            showLoading();
            const res = await api(`/portal/generar-link/${clienteId}`, 'POST', {});
            hideLoading();
            
            if (res.success) {
                const baseUrl = window.location.origin;
                const fullLink = `${baseUrl}/Sistema_CxC/portal_clientes.html?t=${res.token}`;
                
                // Mostrar modal con el link
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal" style="max-width:500px">
                        <div class="modal-header">
                            <h3>üîó Link de Consulta</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom:16px">Link generado para <strong>${clienteNombre}</strong>:</p>
                            <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;word-break:break-all;font-size:13px;margin-bottom:16px">
                                ${fullLink}
                            </div>
                            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">
                                El cliente deber√° ingresar los √∫ltimos 4 d√≠gitos de su c√©dula para verificar su identidad.
                            </p>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${fullLink}'); toast('Link copiado'); this.closest('.modal-overlay').remove()">
                                    <i data-lucide="copy" style="width:16px;height:16px"></i> Copiar Link
                                </button>
                                <button class="btn btn-success" onclick="window.open('https://wa.me/?text=${encodeURIComponent('Hola! Ac√° pod√©s consultar tu estado de cuenta: ' + fullLink)}', '_blank')">
                                    <i data-lucide="message-circle" style="width:16px;height:16px"></i> Enviar WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                lucide.createIcons();
            } else {
                toast('Error al generar link', 'error');
            }
        }

        function clearClienteForm() {
            document.getElementById('cliente-id').value = '';
            document.getElementById('cliente-nombre').value = '';
            document.getElementById('cliente-identificacion').value = '';
            document.getElementById('cliente-dias').value = '8';
            document.getElementById('modal-cliente-titulo').textContent = 'Agregar Cliente';
        }

        // ===================== FACTURAS =====================
        function renderFacturas() {
            const tbody = document.getElementById('tabla-facturas');
            let facs = [...state.facturas];
            
            const busq = document.getElementById('buscar-factura').value.toLowerCase();
            const filtro = document.getElementById('filtro-estado').value;
            const filtroCliente = document.getElementById('filtro-cliente').value;
            const fechaDesde = document.getElementById('filtro-fecha-desde').value;
            const fechaHasta = document.getElementById('filtro-fecha-hasta').value;
            
            // Filtro por texto
            if (busq) facs = facs.filter(f => (f.consecutivo || '').toLowerCase().includes(busq) || (f.clienteNombre || '').toLowerCase().includes(busq));
            
            // Filtro por estado
            if (filtro === 'pendiente') facs = facs.filter(f => !f.pagado && f.estado !== 'Compensado');
            if (filtro === 'pagado') facs = facs.filter(f => f.pagado || f.estado === 'Compensado');
            if (filtro === 'vencida') facs = facs.filter(f => !f.pagado && f.estado !== 'Compensado' && new Date(f.fechaVencimiento) < new Date());
            if (filtro === 'nc') facs = facs.filter(f => f.tipoDocumento === 'NC');
            
            // Filtro por cliente
            if (filtroCliente) facs = facs.filter(f => f.clienteId === filtroCliente);
            
            // Filtro por fecha
            if (fechaDesde) facs = facs.filter(f => new Date(f.fecha) >= new Date(fechaDesde));
            if (fechaHasta) facs = facs.filter(f => new Date(f.fecha) <= new Date(fechaHasta + 'T23:59:59'));

            if (!facs.length) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No hay facturas</td></tr>';
                return;
            }

            facs.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            tbody.innerHTML = facs.map(f => {
                const est = getEstado(f);
                const monto = getMonto(f);
                const esNC = f.tipoDocumento === 'NC';
                const tipoBadge = esNC ? '<span class="badge badge-purple">NC</span>' : '<span class="badge badge-info">FAC</span>';
                
                return `<tr style="${esNC ? 'background: rgba(139, 92, 246, 0.1)' : ''}">
                    <td>${tipoBadge}</td>
                    <td><code>${f.consecutivo || '-'}</code></td>
                    <td>${fmtDate(f.fecha)}</td>
                    <td>${(f.clienteNombre || '').substring(0, 20)}</td>
                    <td style="text-align:right;${esNC ? 'color:var(--accent-red)' : ''}">‚Ç°${fmt(f.totalFactura)}</td>
                    <td style="text-align:right;color:var(--accent-orange)">${f.corfoga ? '‚Ç°' + fmt(f.corfoga) : '-'}</td>
                    <td style="text-align:right;${esNC ? 'color:var(--accent-red)' : ''}" class="${esNC ? '' : 'monto-cobrar'}">‚Ç°${fmt(monto)}</td>
                    <td>${fmtDate(f.fechaVencimiento)}</td>
                    <td><span class="badge badge-${est.c}">${est.t}</span></td>
                    <td class="actions-cell">
                        ${!f.pagado && f.estado !== 'Compensado' ? (esNC ? 
                            `<button class="btn btn-primary btn-sm" onclick="openCompensarNC('${f.id}')" title="Compensar"><i data-lucide="link" style="width:14px;height:14px"></i></button>` :
                            `<button class="btn btn-success btn-sm" onclick="openPago('${f.id}')" title="Pago"><i data-lucide="check" style="width:14px;height:14px"></i></button>
                             <button class="btn btn-info btn-sm" onclick="openHistorialAbonos('${f.id}')" title="Abonos"><i data-lucide="wallet" style="width:14px;height:14px"></i></button>`
                        ) : ''}
                        ${f.pagado && f.fechaPago ? `<button class="btn btn-info btn-sm" onclick="verInfoPago('${f.id}')" title="Ver pago"><i data-lucide="info" style="width:14px;height:14px"></i></button>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="editFactura('${f.id}')"><i data-lucide="edit-2" style="width:14px;height:14px"></i></button>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
            
            // Llenar filtro de clientes si no est√° lleno
            const selCliente = document.getElementById('filtro-cliente');
            if (selCliente.options.length <= 1) {
                fillClienteSelect('filtro-cliente', true);
                document.getElementById('filtro-cliente').insertAdjacentHTML('afterbegin', '<option value="">Todos los clientes</option>');
                document.getElementById('filtro-cliente').value = filtroCliente;
            }
        }

        function limpiarFiltros() {
            document.getElementById('buscar-factura').value = '';
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-cliente').value = '';
            document.getElementById('filtro-fecha-desde').value = '';
            document.getElementById('filtro-fecha-hasta').value = '';
            renderFacturas();
        }

        function getEstado(f) {
            if (f.estado === 'Compensado') return { c: 'purple', t: 'Compensado' };
            if (f.pagado) return { c: 'success', t: 'Pagada' };
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            const v = new Date(f.fechaVencimiento); v.setHours(0,0,0,0);
            const d = Math.ceil((v - hoy) / 86400000);
            if (d < 0) return { c: 'danger', t: `Vencida (${Math.abs(d)}d)` };
            if (d <= 3) return { c: 'warning', t: `Vence ${d}d` };
            return { c: 'info', t: 'Pendiente' };
        }

        async function saveFactura() {
            const clienteId = document.getElementById('factura-cliente').value;
            const cliente = state.clientes.find(c => c.id === clienteId);
            const consecutivo = document.getElementById('factura-consecutivo').value.trim();
            const fecha = document.getElementById('factura-fecha').value;
            const totalFactura = parseFloat(document.getElementById('factura-total').value) || 0;

            if (!consecutivo || !fecha || !clienteId || !totalFactura) { toast('Complet√° los campos', 'error'); return; }

            const dias = cliente?.diasVencimiento || 8;
            const fechaVenc = new Date(new Date(fecha).getTime() + dias * 86400000).toISOString();

            const data = {
                consecutivo,
                fecha: new Date(fecha).toISOString(),
                clienteId,
                clienteNombre: cliente?.nombre || '',
                cedulaCliente: cliente?.identificacion || '',
                totalFactura,
                corfoga: parseFloat(document.getElementById('factura-corfoga').value) || 0,
                otrosRebajos: parseFloat(document.getElementById('factura-otros').value) || 0,
                tipoProducto: document.getElementById('factura-tipo').value,
                ordenCompra: document.getElementById('factura-oc').value,
                fechaVencimiento: fechaVenc
            };

            showLoading();
            const res = await api('/facturas', 'POST', data);
            if (res.success) {
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                closeModal('modal-factura');
                toast('Factura guardada en Sheets');
                clearFacturaForm();
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        function clearFacturaForm() {
            document.getElementById('factura-consecutivo').value = '';
            document.getElementById('factura-total').value = '';
            document.getElementById('factura-corfoga').value = '0';
            document.getElementById('factura-otros').value = '0';
            document.getElementById('factura-tipo').value = '';
            document.getElementById('factura-oc').value = '';
        }

        function editFactura(id) {
            const f = state.facturas.find(x => x.id === id);
            if (!f) return;
            document.getElementById('editar-id').value = f.id;
            document.getElementById('editar-consecutivo').value = f.consecutivo;
            document.getElementById('editar-cliente').value = f.clienteNombre;
            document.getElementById('editar-total').value = f.totalFactura || 0;
            document.getElementById('editar-corfoga').value = f.corfoga || 0;
            document.getElementById('editar-otros').value = f.otrosRebajos || 0;
            document.getElementById('editar-tipo').value = f.tipoProducto || '';
            document.getElementById('editar-oc').value = f.ordenCompra || '';
            calcMontoEdit();
            openModal('modal-editar');
        }

        async function updateFactura() {
            const id = document.getElementById('editar-id').value;
            const data = {
                totalFactura: parseFloat(document.getElementById('editar-total').value) || 0,
                corfoga: parseFloat(document.getElementById('editar-corfoga').value) || 0,
                otrosRebajos: parseFloat(document.getElementById('editar-otros').value) || 0,
                tipoProducto: document.getElementById('editar-tipo').value,
                ordenCompra: document.getElementById('editar-oc').value
            };

            showLoading();
            const res = await api(`/facturas/${id}`, 'PUT', data);
            if (res.success) {
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                closeModal('modal-editar');
                toast('Factura actualizada');
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        function openPago(id) {
            const f = state.facturas.find(x => x.id === id);
            if (!f) return;
            const monto = getMonto(f);
            document.getElementById('pago-id').value = f.id;
            document.getElementById('pago-monto-original').value = monto;
            document.getElementById('pago-factura').value = f.consecutivo + ' - ' + f.clienteNombre;
            document.getElementById('pago-monto').value = '‚Ç°' + fmt(monto);
            document.getElementById('pago-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('pago-metodo').value = 'Transferencia';
            document.getElementById('pago-referencia').value = '';
            document.getElementById('pago-monto-parcial').value = '';
            document.querySelector('input[name="tipo-pago"][value="total"]').checked = true;
            document.getElementById('pago-parcial-grupo').style.display = 'none';
            openModal('modal-pago');
        }
        
        function togglePagoParcial() {
            const esParcial = document.querySelector('input[name="tipo-pago"]:checked').value === 'parcial';
            document.getElementById('pago-parcial-grupo').style.display = esParcial ? 'block' : 'none';
        }

        function verInfoPago(id) {
            const f = state.facturas.find(x => x.id === id);
            if (!f) return;
            document.getElementById('info-pago-factura').textContent = f.consecutivo;
            document.getElementById('info-pago-cliente').textContent = f.clienteNombre;
            document.getElementById('info-pago-monto').textContent = '‚Ç°' + fmt(getMonto(f));
            document.getElementById('info-pago-fecha').textContent = fmtDate(f.fechaPago);
            document.getElementById('info-pago-detalle').textContent = f.notas || 'Sin detalle';
            openModal('modal-info-pago');
        }

        async function doPago() {
            const id = document.getElementById('pago-id').value;
            const fechaPago = document.getElementById('pago-fecha').value;
            const metodo = document.getElementById('pago-metodo').value;
            const referencia = document.getElementById('pago-referencia').value;
            const esParcial = document.querySelector('input[name="tipo-pago"]:checked').value === 'parcial';
            const montoOriginal = parseFloat(document.getElementById('pago-monto-original').value);
            const montoParcial = parseFloat(document.getElementById('pago-monto-parcial').value) || 0;
            
            if (esParcial && (montoParcial <= 0 || montoParcial >= montoOriginal)) {
                toast('El monto parcial debe ser mayor a 0 y menor al total', 'warning');
                return;
            }
            
            let notas = metodo + (referencia ? ' - ' + referencia : '');
            if (esParcial) {
                notas += ` | ABONO: ‚Ç°${fmt(montoParcial)}`;
            }

            showLoading();
            const payload = { fechaPago, notas, metodo, referencia };
            if (esParcial) {
                payload.montoParcial = montoParcial;
            }
            
            const res = await api(`/facturas/${id}/pago`, 'POST', payload);
            if (res.success) {
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                closeModal('modal-pago');
                toast(esParcial ? `Abono de ‚Ç°${fmt(montoParcial)} registrado` : 'Pago registrado');
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        // ===================== COMPENSAR NC =====================
        async function openCompensarNC(ncId) {
            const nc = state.facturas.find(f => f.id === ncId);
            if (!nc) return;
            
            document.getElementById('compensar-nc-id').value = ncId;
            document.getElementById('compensar-nc-consecutivo').textContent = nc.consecutivo;
            document.getElementById('compensar-nc-monto').textContent = '‚Ç°' + fmt(getMonto(nc));
            
            // Cargar facturas pendientes del mismo cliente
            showLoading();
            const res = await api(`/facturas/pendientes/${nc.clienteId}`);
            hideLoading();
            
            if (res.success) {
                const select = document.getElementById('compensar-factura');
                select.innerHTML = '<option value="">-- Seleccionar factura --</option>' + 
                    res.data.map(f => `<option value="${f.id}" data-monto="${f.montoCobrar}">${f.consecutivo} - ‚Ç°${fmt(f.montoCobrar)} (${f.fecha})</option>`).join('');
                
                document.getElementById('compensar-monto').value = Math.abs(getMonto(nc));
                openModal('modal-compensar');
            } else {
                toast('Error cargando facturas', 'error');
            }
        }

        function updateMontoCompensar() {
            const select = document.getElementById('compensar-factura');
            const option = select.options[select.selectedIndex];
            if (option && option.dataset.monto) {
                const montoFac = parseFloat(option.dataset.monto) || 0;
                const ncId = document.getElementById('compensar-nc-id').value;
                const nc = state.facturas.find(f => f.id === ncId);
                const montoNC = Math.abs(getMonto(nc));
                document.getElementById('compensar-monto').value = Math.min(montoFac, montoNC);
            }
        }

        async function doCompensar() {
            const ncId = document.getElementById('compensar-nc-id').value;
            const facturaId = document.getElementById('compensar-factura').value;
            const montoCompensar = parseFloat(document.getElementById('compensar-monto').value) || 0;
            
            if (!facturaId) { toast('Seleccion√° una factura', 'warning'); return; }
            if (montoCompensar <= 0) { toast('Monto inv√°lido', 'warning'); return; }
            
            showLoading();
            const res = await api('/facturas/compensar', 'POST', { ncId, facturaId, montoCompensar });
            if (res.success) {
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                closeModal('modal-compensar');
                toast('Documentos compensados exitosamente');
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        // ===================== DASHBOARD =====================
        function updateDashboard() {
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            // Solo facturas (no NC) pendientes y no compensadas
            const pend = state.facturas.filter(f => !f.pagado && f.estado !== 'Compensado' && f.tipoDocumento !== 'NC');
            const venc = pend.filter(f => new Date(f.fechaVencimiento) < hoy);
            const totalPend = pend.reduce((s, f) => s + getMonto(f), 0);
            
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const cobrado = state.facturas.filter(f => (f.pagado || f.estado === 'Compensado') && f.tipoDocumento !== 'NC' && new Date(f.fechaPago) >= inicioMes).reduce((s, f) => s + getMonto(f), 0);

            document.getElementById('stat-total').textContent = '‚Ç°' + fmt(totalPend);
            document.getElementById('stat-pendientes').textContent = pend.length;
            document.getElementById('stat-vencidas').textContent = venc.length;
            document.getElementById('stat-cobrado').textContent = '‚Ç°' + fmt(cobrado);

            // Alerta cr√≠tica - facturas con m√°s de 30 d√≠as de mora
            const criticas = venc.filter(f => {
                const fv = new Date(f.fechaVencimiento);
                const diasMora = Math.ceil((hoy - fv) / 86400000);
                return diasMora >= 30;
            });
            
            const alertaCritica = document.getElementById('alerta-critica');
            if (criticas.length > 0) {
                const totalCritico = criticas.reduce((s, f) => s + getMonto(f), 0);
                const maxMora = Math.max(...criticas.map(f => Math.ceil((hoy - new Date(f.fechaVencimiento)) / 86400000)));
                document.getElementById('alerta-critica-texto').textContent = 
                    `${criticas.length} factura(s) con m√°s de 30 d√≠as de mora. Total: ‚Ç°${fmt(totalCritico)}. M√°xima mora: ${maxMora} d√≠as.`;
                alertaCritica.style.display = 'flex';
            } else {
                alertaCritica.style.display = 'none';
            }

            // Alertas - solo facturas, no NC
            const alertas = pend.map(f => ({ ...f, dias: Math.ceil((new Date(f.fechaVencimiento) - hoy) / 86400000) }))
                .filter(f => f.dias <= 7)
                .sort((a, b) => a.dias - b.dias)
                .slice(0, 10);

            const tbody = document.getElementById('tabla-alertas');
            if (!alertas.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px">‚úÖ Sin facturas urgentes</td></tr>';
            } else {
                tbody.innerHTML = alertas.map(f => {
                    const est = getEstado(f);
                    return `<tr>
                        <td><code>${f.consecutivo}</code></td>
                        <td>${(f.clienteNombre || '').substring(0, 25)}</td>
                        <td class="monto-cobrar">‚Ç°${fmt(getMonto(f))}</td>
                        <td>${fmtDate(f.fechaVencimiento)}</td>
                        <td><span class="badge badge-${est.c}">${est.t}</span></td>
                    </tr>`;
                }).join('');
            }
            
            // Llenar selector de clientes en dashboard
            fillClienteSelect('dashboard-cliente', true);
            
            // Renderizar gr√°ficos
            renderCharts();
        }
        
        let chartTendencia = null;
        let chartDistribucion = null;
        
        function renderCharts() {
            // Colores
            const colores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'];
            
            // === GR√ÅFICO DE TENDENCIA ===
            const hoy = new Date();
            const meses = [];
            const datosPendiente = [];
            const datosCobrado = [];
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mesNombre = fecha.toLocaleDateString('es-CR', { month: 'short', year: '2-digit' });
                meses.push(mesNombre);
                
                const inicioMes = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                const finMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
                
                // Pendiente al final del mes
                const pendienteMes = state.facturas
                    .filter(f => f.tipoDocumento !== 'NC' && !f.pagado && f.estado !== 'Compensado')
                    .filter(f => new Date(f.fecha) <= finMes)
                    .reduce((s, f) => s + getMonto(f), 0);
                
                // Cobrado en el mes
                const cobradoMes = state.facturas
                    .filter(f => f.tipoDocumento !== 'NC' && (f.pagado || f.estado === 'Compensado'))
                    .filter(f => {
                        const fp = new Date(f.fechaPago);
                        return fp >= inicioMes && fp <= finMes;
                    })
                    .reduce((s, f) => s + getMonto(f), 0);
                
                datosPendiente.push(pendienteMes / 1000000); // En millones
                datosCobrado.push(cobradoMes / 1000000);
            }
            
            const ctxTendencia = document.getElementById('chart-tendencia').getContext('2d');
            if (chartTendencia) chartTendencia.destroy();
            
            chartTendencia = new Chart(ctxTendencia, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Pendiente (M)',
                            data: datosPendiente,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Cobrado (M)',
                            data: datosCobrado,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8', boxWidth: 12 } }
                    },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#94a3b8', callback: v => '‚Ç°' + v + 'M' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
            
            // === GR√ÅFICO DE DISTRIBUCI√ìN ===
            const pendientesPorCliente = {};
            state.facturas
                .filter(f => f.tipoDocumento !== 'NC' && !f.pagado && f.estado !== 'Compensado')
                .forEach(f => {
                    const nombre = (f.clienteNombre || 'Sin cliente').substring(0, 20);
                    pendientesPorCliente[nombre] = (pendientesPorCliente[nombre] || 0) + getMonto(f);
                });
            
            // Ordenar y tomar top 6
            const sorted = Object.entries(pendientesPorCliente).sort((a, b) => b[1] - a[1]);
            const top = sorted.slice(0, 6);
            const otros = sorted.slice(6).reduce((s, x) => s + x[1], 0);
            if (otros > 0) top.push(['Otros', otros]);
            
            const ctxDist = document.getElementById('chart-distribucion').getContext('2d');
            if (chartDistribucion) chartDistribucion.destroy();
            
            chartDistribucion = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: top.map(x => x[0]),
                    datasets: [{
                        data: top.map(x => x[1]),
                        backgroundColor: colores.slice(0, top.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 12, padding: 8 } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ' ‚Ç°' + fmt(ctx.raw)
                            }
                        }
                    }
                }
            });
        }
        
        function verFacturasCriticas() {
            showSection('facturas');
            document.getElementById('filtro-estado').value = 'vencida';
            renderFacturas();
        }

        function updateClienteDashboard() {
            const clienteId = document.getElementById('dashboard-cliente').value;
            const content = document.getElementById('cliente-dashboard-content');
            
            if (!clienteId) {
                content.style.display = 'none';
                return;
            }
            
            content.style.display = 'block';
            const cliente = state.clientes.find(c => c.id === clienteId);
            const facturas = state.facturas.filter(f => f.clienteId === clienteId && f.tipoDocumento !== 'NC');
            const pendientes = facturas.filter(f => !f.pagado && f.estado !== 'Compensado');
            
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            
            // Calcular m√©tricas
            const totalPendiente = pendientes.reduce((s, f) => s + getMonto(f), 0);
            const vencidas = pendientes.filter(f => new Date(f.fechaVencimiento) < hoy);
            const totalVencido = vencidas.reduce((s, f) => s + getMonto(f), 0);
            
            // D√≠as promedio de atraso
            let diasAtraso = 0;
            if (vencidas.length > 0) {
                const totalDias = vencidas.reduce((s, f) => {
                    const fv = new Date(f.fechaVencimiento);
                    return s + Math.ceil((hoy - fv) / 86400000);
                }, 0);
                diasAtraso = Math.round(totalDias / vencidas.length);
            }
            
            // √öltima factura y m√°s antigua pendiente (por fecha de emisi√≥n)
            const facturasOrdenadas = [...facturas]
                .filter(f => f.fecha)
                .sort((a, b) => {
                    const fechaA = new Date(a.fecha.split('T')[0]);
                    const fechaB = new Date(b.fecha.split('T')[0]);
                    return fechaB - fechaA;
                });
            const pendientesOrdenadas = [...pendientes]
                .filter(f => f.fecha)
                .sort((a, b) => {
                    const fechaA = new Date(a.fecha.split('T')[0]);
                    const fechaB = new Date(b.fecha.split('T')[0]);
                    return fechaA - fechaB;  // M√°s antigua primero
                });
            
            // Actualizar UI
            document.getElementById('cliente-pendiente').textContent = '‚Ç°' + fmt(totalPendiente);
            document.getElementById('cliente-vencido').textContent = '‚Ç°' + fmt(totalVencido);
            document.getElementById('cliente-cant-pend').textContent = pendientes.length;
            document.getElementById('cliente-dias-atraso').textContent = diasAtraso;
            document.getElementById('cliente-ultima-fac').textContent = facturasOrdenadas.length ? fmtDate(facturasOrdenadas[0].fecha) : '-';
            document.getElementById('cliente-dias-credito').textContent = cliente?.diasCredito || 8;
            document.getElementById('cliente-cedula').textContent = cliente?.identificacion || '-';
            document.getElementById('cliente-fac-antigua').textContent = pendientesOrdenadas.length ? fmtDate(pendientesOrdenadas[0].fecha) : '-';
            
            lucide.createIcons();
        }

        function generarEstadoCuentaRapido() {
            const clienteId = document.getElementById('dashboard-cliente').value;
            if (!clienteId) return;
            
            // Llamar directo al API sin usar el modal
            showLoading();
            const timestamp = new Date().getTime();
            fetch(`${API}/reportes/cliente/${clienteId}/pdf?t=${timestamp}`)
                .then(res => res.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Estado_Cuenta_${timestamp}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                    toast('PDF descargado');
                    hideLoading();
                })
                .catch(e => {
                    toast('Error generando PDF', 'error');
                    hideLoading();
                });
        }

        function verFacturasCliente() {
            const clienteId = document.getElementById('dashboard-cliente').value;
            if (!clienteId) return;
            
            const cliente = state.clientes.find(c => c.id === clienteId);
            if (cliente) {
                // Ir a secci√≥n facturas y filtrar por cliente
                showSection('facturas');
                document.getElementById('buscar-factura').value = cliente.nombre.substring(0, 15);
                renderFacturas();
            }
        }

        // ===================== IMPORTAR =====================
        function handleFile(file) {
            if (!file) return;
            document.getElementById('filename').textContent = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                if (json.length < 2) { toast('Archivo vac√≠o', 'error'); return; }
                state.excelCols = json[0].map((c, i) => ({ i, n: c || 'Col ' + (i+1) }));
                state.excelData = json.slice(1).filter(r => r.some(c => c));
                showMapper();
            };
            reader.readAsArrayBuffer(file);
        }

        function showMapper() {
            document.getElementById('mapper-section').style.display = 'block';
            document.getElementById('preview-section').style.display = 'none';
            const fields = [
                { k: 'consecutivo', l: 'Consecutivo *' },
                { k: 'fecha', l: 'Fecha *' },
                { k: 'cliente', l: 'Cliente *' },
                { k: 'cedula', l: 'C√©dula Cliente' },
                { k: 'total', l: 'Total Factura *' }
            ];
            document.getElementById('mapper-grid').innerHTML = fields.map(f => `
                <div class="mapper-item">
                    <label>${f.l}</label>
                    <select id="map-${f.k}">
                        <option value="">-- Seleccionar --</option>
                        ${state.excelCols.map(c => `<option value="${c.i}">${c.n}</option>`).join('')}
                    </select>
                </div>
            `).join('');
            autoDetect();
        }

        function autoDetect() {
            const kw = {
                consecutivo: ['consecutivo', 'numero', 'documento'],
                fecha: ['fecha'],
                cliente: ['cliente', 'nombre'],
                cedula: ['cedula', 'identificacion'],
                total: ['total', 'monto', 'venta']
            };
            state.excelCols.forEach(col => {
                const n = col.n.toLowerCase();
                for (const [f, words] of Object.entries(kw)) {
                    if (words.some(w => n.includes(w))) {
                        const sel = document.getElementById('map-' + f);
                        if (sel && !sel.value) sel.value = col.i;
                    }
                }
            });
        }

        function previewImport() {
            const get = (row, k) => {
                const sel = document.getElementById('map-' + k);
                const i = sel?.value;
                return i !== '' ? row[parseInt(i)] : null;
            };

            const activos = state.clientes.filter(c => c.activo !== false);
            if (!activos.length) { toast('Primero agreg√° clientes', 'warning'); return; }

            const preview = state.excelData.map(row => {
                const cons = String(get(row, 'consecutivo') || '').trim();
                const cliN = String(get(row, 'cliente') || '').trim();
                const ced = String(get(row, 'cedula') || '').trim();
                let fecha = get(row, 'fecha');
                if (fecha instanceof Date) fecha = fecha.toISOString();
                const total = parseFloat(get(row, 'total')) || 0;

                let match = activos.find(c => ced && c.identificacion.includes(ced));
                if (!match) match = activos.find(c => cliN.toLowerCase().includes(c.nombre.toLowerCase().substring(0, 10)));

                const existe = state.facturas.some(f => f.consecutivo === cons);

                return { cons, fecha, cliente: match, total, existe };
            }).filter(r => r.cons && r.cliente && !r.existe);

            state.importPreview = preview;
            document.getElementById('preview-count').textContent = preview.length;
            document.getElementById('preview-tbody').innerHTML = preview.map(r => `
                <tr>
                    <td><code>${r.cons}</code></td>
                    <td>${fmtDate(r.fecha)}</td>
                    <td>${r.cliente.nombre}</td>
                    <td style="text-align:right">‚Ç°${fmt(r.total)}</td>
                </tr>
            `).join('');

            document.getElementById('preview-section').style.display = 'block';
            if (!preview.length) toast('No hay facturas nuevas para importar', 'warning');
        }

        async function doImport() {
            if (!state.importPreview?.length) { toast('No hay facturas', 'warning'); return; }

            const facturas = state.importPreview.map(r => {
                const dias = r.cliente.diasVencimiento || 8;
                
                // Parsear fecha correctamente (puede venir en varios formatos)
                let fechaBase;
                if (r.fecha) {
                    // Si viene en formato dd-mm-yyyy o dd/mm/yyyy
                    if (r.fecha.includes('-') || r.fecha.includes('/')) {
                        const sep = r.fecha.includes('-') ? '-' : '/';
                        const parts = r.fecha.split(sep);
                        if (parts.length === 3) {
                            // Detectar si es dd-mm-yyyy o yyyy-mm-dd
                            if (parts[0].length === 4) {
                                // yyyy-mm-dd
                                fechaBase = new Date(parts[0], parts[1] - 1, parts[2]);
                            } else {
                                // dd-mm-yyyy
                                fechaBase = new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                        }
                    } else {
                        fechaBase = new Date(r.fecha);
                    }
                }
                
                // Si no se pudo parsear, usar fecha actual
                if (!fechaBase || isNaN(fechaBase.getTime())) {
                    fechaBase = new Date();
                }
                
                const fechaVenc = new Date(fechaBase.getTime() + dias * 86400000);
                
                return {
                    consecutivo: r.cons,
                    fecha: fechaBase.toISOString().split('T')[0],
                    clienteId: r.cliente.id,
                    clienteNombre: r.cliente.nombre,
                    cedulaCliente: r.cliente.identificacion,
                    totalFactura: r.total,
                    corfoga: 0,
                    otrosRebajos: 0,
                    tipoProducto: '',
                    ordenCompra: '',
                    fechaVencimiento: fechaVenc.toISOString().split('T')[0]
                };
            });

            showLoading();
            const res = await api('/facturas/batch', 'POST', { facturas });
            if (res.success) {
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                
                // Mensaje con info de duplicados
                let mensaje = `${res.count} facturas importadas`;
                if (res.duplicados > 0) {
                    mensaje += ` | ${res.duplicados} duplicadas omitidas`;
                    toast(mensaje, 'warning');
                } else {
                    toast(mensaje);
                }
                
                // Reset
                document.getElementById('mapper-section').style.display = 'none';
                document.getElementById('preview-section').style.display = 'none';
                document.getElementById('filename').textContent = '';
                state.excelData = [];
                state.importPreview = [];
            } else {
                toast('Error: ' + res.error, 'error');
            }
            hideLoading();
        }

        // ===================== REPORTES =====================
        async function downloadReport(tipo) {
            if (!state.connected) { toast('Sin conexi√≥n', 'error'); return; }
            showLoading();
            try {
                const timestamp = new Date().getTime();
                const res = await fetch(`${API}/reportes/${tipo}?t=${timestamp}`);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const esPDF = tipo.includes('/pdf');
                const nombreTipo = tipo.replace('/pdf', '').replace('/', '_');
                a.download = `Reporte_${nombreTipo}_${new Date().toISOString().split('T')[0]}_${timestamp}.${esPDF ? 'pdf' : 'xlsx'}`;
                a.click();
                URL.revokeObjectURL(url);
                toast('Reporte descargado');
            } catch (e) {
                toast('Error al generar reporte', 'error');
            }
            hideLoading();
        }

        async function downloadReportCliente() {
            const id = document.getElementById('reporte-cliente').value;
            if (!id) { toast('Seleccion√° un cliente', 'warning'); return; }
            closeModal('modal-reporte-cliente');
            showLoading();
            try {
                const res = await fetch(`${API}/reportes/cliente/${id}`);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Estado_Cuenta_${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
                toast('Reporte descargado');
            } catch (e) {
                toast('Error', 'error');
            }
            hideLoading();
        }

        async function downloadReportClientePDF() {
            const id = document.getElementById('reporte-cliente-pdf').value;
            if (!id) { toast('Seleccion√° un cliente', 'warning'); return; }
            closeModal('modal-reporte-cliente-pdf');
            showLoading();
            try {
                const timestamp = new Date().getTime();
                const res = await fetch(`${API}/reportes/cliente/${id}/pdf?t=${timestamp}`);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Estado_Cuenta_${new Date().toISOString().split('T')[0]}_${timestamp}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
                toast('PDF descargado');
            } catch (e) {
                toast('Error', 'error');
            }
            hideLoading();
        }

        // ===================== CONFIGURACI√ìN =====================
        async function loadConfig() {
            const res = await api('/config');
            if (res.success && res.config) {
                document.getElementById('config-nombre').value = res.config.nombre || '';
                document.getElementById('config-cedula').value = res.config.cedula || '';
                document.getElementById('config-descripcion').value = res.config.descripcion || '';
                document.getElementById('config-telefono').value = res.config.telefono || '';
                document.getElementById('config-email').value = res.config.email || '';
                document.getElementById('config-direccion').value = res.config.direccion || '';
                document.getElementById('config-mensaje').value = res.config.mensaje || '';
            }
        }

        async function saveConfig() {
            const config = {
                nombre: document.getElementById('config-nombre').value,
                cedula: document.getElementById('config-cedula').value,
                descripcion: document.getElementById('config-descripcion').value,
                telefono: document.getElementById('config-telefono').value,
                email: document.getElementById('config-email').value,
                direccion: document.getElementById('config-direccion').value,
                mensaje: document.getElementById('config-mensaje').value
            };
            
            showLoading();
            const res = await api('/config', 'POST', config);
            if (res.success) {
                toast('Configuraci√≥n guardada');
            } else {
                toast('Error al guardar', 'error');
            }
            hideLoading();
        }

        // ===================== DASHBOARD READONLY =====================
        let dashboardLinkActual = '';
        
        async function generarAccesoDashboard() {
            const codigo = document.getElementById('dashboard-codigo').value.trim();
            if (!codigo || codigo.length < 4) {
                toast('El c√≥digo debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            showLoading();
            const res = await api('/dashboard/generar-acceso', 'POST', { codigo });
            hideLoading();
            
            if (res.success) {
                const baseUrl = window.location.origin;
                dashboardLinkActual = `${baseUrl}/Sistema_CxC/dashboard_readonly.html?t=${res.token}`;
                
                document.getElementById('dashboard-link-url').textContent = dashboardLinkActual;
                document.getElementById('dashboard-link-resultado').style.display = 'block';
                toast('Link generado correctamente');
            } else {
                toast(res.error || 'Error al generar link', 'error');
            }
        }
        
        function copiarLinkDashboard() {
            navigator.clipboard.writeText(dashboardLinkActual);
            toast('Link copiado al portapapeles');
        }
        
        function enviarLinkDashboardWhatsApp() {
            const mensaje = `Hola! Ac√° pod√©s consultar el estado de tus cuentas por cobrar: ${dashboardLinkActual}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        // ===================== NEGOCIOS =====================
        async function loadNegocios() {
            const res = await api('/negocios');
            if (res.success) {
                state.negocios = res.data || [];
                renderNegocios();
                fillNegocioSelect();
            }
        }

        function renderNegocios() {
            const tbody = document.getElementById('tabla-negocios');
            if (!state.negocios?.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay negocios configurados. Agreg√° uno para comenzar.</td></tr>';
                return;
            }
            
            tbody.innerHTML = state.negocios.map(n => `
                <tr>
                    <td><strong>${n.nombre}</strong></td>
                    <td>${n.descripcion || '-'}</td>
                    <td><code style="font-size:11px">${n.sheetId?.substring(0, 20)}...</code></td>
                    <td>${n.activo ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-info">Inactivo</span>'}</td>
                    <td class="actions-cell">
                        ${!n.activo ? `<button class="btn btn-success btn-sm" onclick="activarNegocio('${n.id}')" title="Activar"><i data-lucide="check" style="width:14px;height:14px"></i></button>` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="editNegocio('${n.id}')" title="Editar"><i data-lucide="edit-2" style="width:14px;height:14px"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNegocio('${n.id}')" title="Eliminar"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function fillNegocioSelect() {
            const select = document.getElementById('select-negocio');
            select.innerHTML = '<option value="">-- Seleccionar --</option>' +
                (state.negocios || []).map(n => `<option value="${n.id}" ${n.activo ? 'selected' : ''}>${n.nombre}</option>`).join('');
            
            // Actualizar nombre en header
            const activo = state.negocios?.find(n => n.activo);
            document.getElementById('negocio-nombre').textContent = activo?.nombre || 'Sin negocio';
        }

        async function cambiarNegocio() {
            const negocioId = document.getElementById('select-negocio').value;
            if (!negocioId) return;
            
            showLoading();
            const res = await api(`/negocios/activar/${negocioId}`, 'POST');
            if (res.success) {
                toast(`Negocio cambiado: ${res.nombre}`);
                document.getElementById('negocio-nombre').textContent = res.nombre;
                // Recargar todos los datos
                await loadNegocios();
                await loadClientes();
                await loadFacturas();
                await loadConfig();
                updateDashboard();
                renderClientes();
                renderFacturas();
            } else {
                toast('Error al cambiar negocio', 'error');
            }
            hideLoading();
        }

        async function activarNegocio(id) {
            document.getElementById('select-negocio').value = id;
            await cambiarNegocio();
        }

        function editNegocio(id) {
            const n = state.negocios.find(x => x.id === id);
            if (!n) return;
            document.getElementById('negocio-id').value = n.id;
            document.getElementById('negocio-nombre-input').value = n.nombre;
            document.getElementById('negocio-descripcion').value = n.descripcion || '';
            document.getElementById('negocio-sheet-id').value = n.sheetId;
            document.getElementById('modal-negocio-titulo').textContent = 'Editar Negocio';
            openModal('modal-negocio');
        }

        async function deleteNegocio(id) {
            if (!confirm('¬øEliminar este negocio? Los datos en el Sheet NO se eliminar√°n.')) return;
            showLoading();
            const res = await api(`/negocios/${id}`, 'DELETE');
            if (res.success) {
                await loadNegocios();
                toast('Negocio eliminado');
            } else {
                toast('Error', 'error');
            }
            hideLoading();
        }

        async function saveNegocio() {
            const id = document.getElementById('negocio-id').value;
            const nombre = document.getElementById('negocio-nombre-input').value.trim();
            const sheetId = document.getElementById('negocio-sheet-id').value.trim();
            
            if (!nombre || !sheetId) {
                toast('Complet√° nombre y Sheet ID', 'warning');
                return;
            }
            
            const data = {
                nombre,
                descripcion: document.getElementById('negocio-descripcion').value,
                sheetId
            };
            
            showLoading();
            let res;
            if (id) {
                res = await api(`/negocios/${id}`, 'PUT', data);
            } else {
                res = await api('/negocios', 'POST', data);
            }
            
            if (res.success) {
                closeModal('modal-negocio');
                await loadNegocios();
                toast(id ? 'Negocio actualizado' : 'Negocio agregado');
                // Limpiar form
                document.getElementById('negocio-id').value = '';
                document.getElementById('negocio-nombre-input').value = '';
                document.getElementById('negocio-descripcion').value = '';
                document.getElementById('negocio-sheet-id').value = '';
                document.getElementById('modal-negocio-titulo').textContent = 'Agregar Negocio';
            } else {
                toast('Error: ' + (res.error || 'Desconocido'), 'error');
            }
            hideLoading();
        }

        // ===================== INIT =====================
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await checkConnection();
            if (state.connected) {
                showLoading();
                // Cargar negocios primero
                await loadNegocios();
                // Si hay negocio activo, cargar sus datos
                const negocioActivo = state.negocios?.find(n => n.activo);
                if (negocioActivo) {
                    await loadClientes();
                    await loadFacturas();
                    await loadConfig();
                    updateDashboard();
                    renderClientes();
                    renderFacturas();
                }
                hideLoading();
            }
        });

        // Drag & drop
        const dz = document.getElementById('dropzone');
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.borderColor = 'var(--accent-blue)'; });
        dz.addEventListener('dragleave', () => dz.style.borderColor = 'var(--border)');
        dz.addEventListener('drop', e => { e.preventDefault(); dz.style.borderColor = 'var(--border)'; handleFile(e.dataTransfer.files[0]); });

        // ===================== ANTIG√úEDAD DE CARTERA =====================
        
        async function loadAntiguedad() {
            showLoading();
            const res = await api('/reportes/antiguedad');
            hideLoading();
            
            if (res.success) {
                state.antiguedad = res.data;
                renderAntiguedadStats();
                renderAntiguedadChart();
                renderAntiguedad();
            } else {
                toast('Error cargando antig√ºedad: ' + res.error, 'error');
            }
        }

        function renderAntiguedadStats() {
            if (!state.antiguedad) return;
            const { cartera } = state.antiguedad;
            
            document.getElementById('ant-corriente').textContent = '‚Ç°' + fmt(cartera.corriente.total);
            document.getElementById('ant-corriente-pct').textContent = cartera.corriente.porcentaje + '% (' + cartera.corriente.cantidad + ' fact.)';
            
            document.getElementById('ant-31-60').textContent = '‚Ç°' + fmt(cartera.dias_31_60.total);
            document.getElementById('ant-31-60-pct').textContent = cartera.dias_31_60.porcentaje + '% (' + cartera.dias_31_60.cantidad + ' fact.)';
            
            document.getElementById('ant-61-90').textContent = '‚Ç°' + fmt(cartera.dias_61_90.total);
            document.getElementById('ant-61-90-pct').textContent = cartera.dias_61_90.porcentaje + '% (' + cartera.dias_61_90.cantidad + ' fact.)';
            
            document.getElementById('ant-90-mas').textContent = '‚Ç°' + fmt(cartera.dias_90_mas.total);
            document.getElementById('ant-90-mas-pct').textContent = cartera.dias_90_mas.porcentaje + '% (' + cartera.dias_90_mas.cantidad + ' fact.)';
        }

        function renderAntiguedadChart() {
            if (!state.antiguedad) return;
            const { cartera } = state.antiguedad;
            
            const ctx = document.getElementById('chart-antiguedad');
            if (!ctx) return;
            
            if (chartAntiguedad) chartAntiguedad.destroy();
            
            chartAntiguedad = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-30 d√≠as', '31-60 d√≠as', '61-90 d√≠as', '+90 d√≠as'],
                    datasets: [{
                        label: 'Monto',
                        data: [cartera.corriente.total, cartera.dias_31_60.total, cartera.dias_61_90.total, cartera.dias_90_mas.total],
                        backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(245,158,11,0.8)', 'rgba(249,115,22,0.8)', 'rgba(239,68,68,0.8)'],
                        borderColor: ['rgb(16,185,129)', 'rgb(245,158,11)', 'rgb(249,115,22)', 'rgb(239,68,68)'],
                        borderWidth: 2, borderRadius: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => '‚Ç°' + fmt(ctx.raw) } } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: val => '‚Ç°' + fmt(val), color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }

        function renderAntiguedad() {
            if (!state.antiguedad) return;
            const { cartera } = state.antiguedad;
            const filtro = document.getElementById('filtro-antiguedad')?.value || 'todas';
            
            let facturas = [];
            const catMap = {
                'corriente': { data: cartera.corriente.facturas, label: '0-30 d√≠as', cls: 'badge-success' },
                'dias_31_60': { data: cartera.dias_31_60.facturas, label: '31-60 d√≠as', cls: 'badge-warning' },
                'dias_61_90': { data: cartera.dias_61_90.facturas, label: '61-90 d√≠as', cls: 'badge-warning' },
                'dias_90_mas': { data: cartera.dias_90_mas.facturas, label: '+90 d√≠as', cls: 'badge-danger' }
            };
            
            if (filtro === 'todas') {
                Object.keys(catMap).forEach(k => {
                    facturas.push(...catMap[k].data.map(f => ({...f, categoria: catMap[k].label, catClass: catMap[k].cls})));
                });
            } else {
                const cat = catMap[filtro];
                facturas = cat.data.map(f => ({...f, categoria: cat.label, catClass: cat.cls}));
            }
            
            facturas.sort((a, b) => b.diasVencido - a.diasVencido);
            
            const tbody = document.getElementById('tabla-antiguedad');
            if (!tbody) return;
            
            if (facturas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-secondary)">No hay facturas</td></tr>';
                return;
            }
            
            tbody.innerHTML = facturas.map(f => `
                <tr>
                    <td><strong>${f.consecutivo}</strong></td>
                    <td>${f.clienteNombre}</td>
                    <td>${fmtDate(f.fechaVencimiento)}</td>
                    <td>‚Ç°${fmt(f.montoCobrar)}</td>
                    <td style="color:var(--accent-green)">‚Ç°${fmt(f.totalAbonado || 0)}</td>
                    <td><strong style="color:var(--accent-orange)">‚Ç°${fmt(f.saldoPendiente)}</strong></td>
                    <td><span class="badge ${f.diasVencido > 60 ? 'badge-danger' : f.diasVencido > 30 ? 'badge-warning' : 'badge-info'}">${f.diasVencido}d</span></td>
                    <td><span class="badge ${f.catClass}">${f.categoria}</span></td>
                    <td><button class="btn btn-sm btn-info" onclick="verFacturaDesdeAntiguedad('${f.consecutivo}')"><i data-lucide="eye" style="width:14px;height:14px"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function verFacturaDesdeAntiguedad(consecutivo) {
            showSection('facturas');
            document.getElementById('buscar-factura').value = consecutivo;
            renderFacturas();
        }

        async function exportAntiguedadExcel() {
            showLoading();
            try {
                const response = await fetch(`${API}/reportes/antiguedad/excel`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `antiguedad_cartera_${new Date().toISOString().slice(0,10)}.xlsx`;
                a.click(); URL.revokeObjectURL(url);
                toast('Excel descargado');
            } catch (e) { toast('Error descargando', 'error'); }
            hideLoading();
        }

        async function exportAntiguedadPDF() {
            showLoading();
            try {
                const response = await fetch(`${API}/reportes/antiguedad/pdf`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `antiguedad_cartera_${new Date().toISOString().slice(0,10)}.pdf`;
                a.click(); URL.revokeObjectURL(url);
                toast('PDF descargado');
            } catch (e) { toast('Error descargando', 'error'); }
            hideLoading();
        }

        // ===================== ABONOS PARCIALES =====================
        async function openHistorialAbonos(facturaId) {
            const factura = state.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            document.getElementById('abonos-factura-id').value = facturaId;
            document.getElementById('abonos-consecutivo').textContent = factura.consecutivo;
            document.getElementById('abonos-cliente').textContent = factura.clienteNombre;
            document.getElementById('abonos-monto-cobrar').textContent = '‚Ç°' + fmt(factura.montoCobrar);
            document.getElementById('nuevo-abono-fecha').value = new Date().toISOString().slice(0, 10);
            document.getElementById('nuevo-abono-monto').value = '';
            document.getElementById('nuevo-abono-referencia').value = '';
            
            openModal('modal-abonos');
            await cargarAbonos(facturaId);
        }

        async function cargarAbonos(facturaId) {
            const listaEl = document.getElementById('lista-abonos');
            listaEl.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-secondary)">Cargando...</p>';
            
            const res = await api(`/facturas/${facturaId}/abonos`);
            
            if (res.success) {
                const factura = state.facturas.find(f => f.id === facturaId);
                const montoCobrar = factura?.montoCobrar || 0;
                const totalAbonado = res.totalAbonado || 0;
                const saldo = montoCobrar - totalAbonado;
                
                document.getElementById('abonos-total').textContent = '‚Ç°' + fmt(totalAbonado);
                document.getElementById('abonos-saldo').textContent = '‚Ç°' + fmt(saldo);
                
                if (res.data.length === 0) {
                    listaEl.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-secondary)">No hay abonos registrados</p>';
                } else {
                    listaEl.innerHTML = res.data.map(a => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px">
                            <div>
                                <strong style="color:var(--accent-green)">‚Ç°${fmt(a.monto)}</strong>
                                <br><small style="color:var(--text-secondary)">${fmtDate(a.fecha)} ‚Ä¢ ${a.metodoPago}${a.referencia ? ' ‚Ä¢ ' + a.referencia : ''}</small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="eliminarAbono('${a.id}', '${facturaId}')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                        </div>
                    `).join('');
                    lucide.createIcons();
                }
            }
        }

        async function registrarAbono() {
            const facturaId = document.getElementById('abonos-factura-id').value;
            const monto = parseFloat(document.getElementById('nuevo-abono-monto').value);
            const fecha = document.getElementById('nuevo-abono-fecha').value;
            const metodoPago = document.getElementById('nuevo-abono-metodo').value;
            const referencia = document.getElementById('nuevo-abono-referencia').value;
            
            if (!monto || monto <= 0) { toast('Ingres√° un monto v√°lido', 'warning'); return; }
            
            showLoading();
            const res = await api('/abonos', 'POST', { facturaId, monto, fecha, metodoPago, referencia });
            hideLoading();
            
            if (res.success) {
                toast(`Abono de ‚Ç°${fmt(monto)} registrado`);
                document.getElementById('nuevo-abono-monto').value = '';
                document.getElementById('nuevo-abono-referencia').value = '';
                await cargarAbonos(facturaId);
                await loadFacturas();
                renderFacturas();
                updateDashboard();
                if (res.abono?.pagadoCompleto) { closeModal('modal-abonos'); toast('¬°Factura pagada!', 'success'); }
            } else {
                toast('Error: ' + res.error, 'error');
            }
        }

        async function eliminarAbono(abonoId, facturaId) {
            if (!confirm('¬øEliminar este abono?')) return;
            showLoading();
            const res = await api(`/abonos/${abonoId}`, 'DELETE');
            hideLoading();
            if (res.success) {
                toast('Abono eliminado');
                await cargarAbonos(facturaId);
                await loadFacturas();
                renderFacturas();
                updateDashboard();
            } else {
                toast('Error: ' + res.error, 'error');
            }
        }
    </script>
</body>
</html>
